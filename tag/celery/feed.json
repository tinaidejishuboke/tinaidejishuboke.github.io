{
    "version": "https://jsonfeed.org/version/1",
    "title": "路宇航的博客 • All posts by \"celery\" tag",
    "description": "",
    "home_page_url": "https://github.com/tinaidejishuboke/tinaidejishuboke.github.io",
    "items": [
        {
            "id": "https://github.com/tinaidejishuboke/tinaidejishuboke.github.io/2018/11/13/celery%E5%BC%82%E6%AD%A5/",
            "url": "https://github.com/tinaidejishuboke/tinaidejishuboke.github.io/2018/11/13/celery%E5%BC%82%E6%AD%A5/",
            "title": "celery异步",
            "date_published": "2018-11-13T07:18:58.000Z",
            "content_html": "<h2 id=\"这是使用celery异步发送短信的方法\"><a class=\"markdownIt-Anchor\" href=\"#这是使用celery异步发送短信的方法\">#</a> 这是使用 celery 异步发送短信的方法</h2>\n<h2 id=\"安装celery以及redis\"><a class=\"markdownIt-Anchor\" href=\"#安装celery以及redis\">#</a> 安装 celery 以及 redis</h2>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install celery&#x3D;&#x3D;3.1.2</span><br><span class=\"line\">pip install redis&#x3D;&#x3D;2.1.6</span><br></pre></td></tr></table></figure>\n<h2 id=\"在setting中配置celery\"><a class=\"markdownIt-Anchor\" href=\"#在setting中配置celery\">#</a> 在 setting 中配置 celery</h2>\n<p><img data-src=\"https://i.loli.net/2021/01/30/aVxySodZzXDBLsb.jpg\" alt=\"img\"></p>\n<h2 id=\"配置broker消息队列的地址我是在setting中配置的\"><a class=\"markdownIt-Anchor\" href=\"#配置broker消息队列的地址我是在setting中配置的\">#</a> 配置 broker 消息队列的地址 (我是在 setting 中配置的)</h2>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import djcelery</span><br><span class=\"line\">djcelery.setup_loader()</span><br><span class=\"line\">BROKER_URL &#x3D; &#39;redis:&#x2F;&#x2F;123.57.61.168:6379&#39;</span><br></pre></td></tr></table></figure>\n<h2 id=\"创建一个taskspy的文件-写异步代码\"><a class=\"markdownIt-Anchor\" href=\"#创建一个taskspy的文件-写异步代码\">#</a> 创建一个 tasks.py 的文件 写异步代码</h2>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from celery.task import task</span><br><span class=\"line\">from ronglian_sms_sdk import SmsSDK</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\"># 这是发送短信的服务部分</span><br><span class=\"line\">ACCOUNT_SID &#x3D; &#39;&#39;</span><br><span class=\"line\">AUTH_TOKEN &#x3D; &#39;&#39;</span><br><span class=\"line\">APP_ID &#x3D; &#39;&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">def sdk(ACCOUNT_SID, AUTH_TOKEN, APP_ID):</span><br><span class=\"line\">    return SmsSDK(ACCOUNT_SID, AUTH_TOKEN, APP_ID)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">@task  # 升级为异步的标志</span><br><span class=\"line\">def send(sms, tid&#x3D;1, mobile&#x3D;[], datas&#x3D;[]):</span><br><span class=\"line\">    # time.sleep(5)</span><br><span class=\"line\">    tid &#x3D; tid  # 登录验证模版 默认ID为1</span><br><span class=\"line\">    mobile &#x3D; &#39;,&#39;.join(mobile) if len(mobile) &gt; 1 else mobile[0]  # 接收的手机号列表</span><br><span class=\"line\">    datas &#x3D; datas</span><br><span class=\"line\">    sms.sendMessage(tid, mobile, datas)</span><br></pre></td></tr></table></figure>\n<h2 id=\"接下来就可以在view中发送短信了\"><a class=\"markdownIt-Anchor\" href=\"#接下来就可以在view中发送短信了\">#</a> 接下来就可以在 view 中发送短信了</h2>\n<p>send.delay 发送短信</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sms &#x3D; sdk(ACCOUNT_SID, AUTH_TOKEN, APP_ID)</span><br><span class=\"line\">a &#x3D; random.sample([str(i) for i in range(10)], 6)</span><br><span class=\"line\">code &#x3D; &#39;&#39;.join(a)</span><br><span class=\"line\">r.set(phone, code, 60)</span><br><span class=\"line\">datas &#x3D; [code, &#39;60s&#39;]</span><br><span class=\"line\">send.delay(sms, mobile&#x3D;[phone], datas&#x3D;datas)</span><br><span class=\"line\"># 直接加入消息队列，由celery去管理</span><br></pre></td></tr></table></figure>\n<h2 id=\"需要运行两个终端-一个程序-一个异步的终端\"><a class=\"markdownIt-Anchor\" href=\"#需要运行两个终端-一个程序-一个异步的终端\">#</a> 需要运行两个终端 一个程序 一个异步的终端</h2>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">py manage.py celery worker</span><br></pre></td></tr></table></figure>",
            "tags": [
                "Celery"
            ]
        }
    ]
}