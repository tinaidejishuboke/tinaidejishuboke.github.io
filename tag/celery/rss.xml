<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>路宇航的博客 • Posts by &#34;celery&#34; tag</title>
        <link>https://github.com/tinaidejishuboke/tinaidejishuboke.github.io</link>
        <description></description>
        <language>en</language>
        <pubDate>Tue, 13 Nov 2018 15:18:58 +0800</pubDate>
        <lastBuildDate>Tue, 13 Nov 2018 15:18:58 +0800</lastBuildDate>
        <category>Ant Design</category>
        <category>数据库</category>
        <category>Python</category>
        <category>Celery</category>
        <category>Git</category>
        <category>Docker</category>
        <category>Redis</category>
        <category>Vue</category>
        <category>python</category>
        <category>三方支付</category>
        <category>算法</category>
        <item>
            <guid isPermalink="true">https://github.com/tinaidejishuboke/tinaidejishuboke.github.io/2018/11/13/celery%E5%BC%82%E6%AD%A5/</guid>
            <title>celery异步</title>
            <link>https://github.com/tinaidejishuboke/tinaidejishuboke.github.io/2018/11/13/celery%E5%BC%82%E6%AD%A5/</link>
            <category>Celery</category>
            <pubDate>Tue, 13 Nov 2018 15:18:58 +0800</pubDate>
            <description><![CDATA[ &lt;h2 id=&#34;这是使用celery异步发送短信的方法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#这是使用celery异步发送短信的方法&#34;&gt;#&lt;/a&gt; 这是使用 celery 异步发送短信的方法&lt;/h2&gt;
&lt;h2 id=&#34;安装celery以及redis&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装celery以及redis&#34;&gt;#&lt;/a&gt; 安装 celery 以及 redis&lt;/h2&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;pip install celery&amp;#x3D;&amp;#x3D;3.1.2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pip install redis&amp;#x3D;&amp;#x3D;2.1.6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;在setting中配置celery&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#在setting中配置celery&#34;&gt;#&lt;/a&gt; 在 setting 中配置 celery&lt;/h2&gt;
&lt;p&gt;&lt;img data-src=&#34;https://i.loli.net/2021/01/30/aVxySodZzXDBLsb.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;配置broker消息队列的地址我是在setting中配置的&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#配置broker消息队列的地址我是在setting中配置的&#34;&gt;#&lt;/a&gt; 配置 broker 消息队列的地址 (我是在 setting 中配置的)&lt;/h2&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import djcelery&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;djcelery.setup_loader()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BROKER_URL &amp;#x3D; &amp;#39;redis:&amp;#x2F;&amp;#x2F;123.57.61.168:6379&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;创建一个taskspy的文件-写异步代码&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#创建一个taskspy的文件-写异步代码&#34;&gt;#&lt;/a&gt; 创建一个 tasks.py 的文件 写异步代码&lt;/h2&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from celery.task import task&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from ronglian_sms_sdk import SmsSDK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import time&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 这是发送短信的服务部分&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ACCOUNT_SID &amp;#x3D; &amp;#39;&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;AUTH_TOKEN &amp;#x3D; &amp;#39;&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;APP_ID &amp;#x3D; &amp;#39;&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def sdk(ACCOUNT_SID, AUTH_TOKEN, APP_ID):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return SmsSDK(ACCOUNT_SID, AUTH_TOKEN, APP_ID)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@task  # 升级为异步的标志&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def send(sms, tid&amp;#x3D;1, mobile&amp;#x3D;[], datas&amp;#x3D;[]):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # time.sleep(5)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tid &amp;#x3D; tid  # 登录验证模版 默认ID为1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    mobile &amp;#x3D; &amp;#39;,&amp;#39;.join(mobile) if len(mobile) &amp;gt; 1 else mobile[0]  # 接收的手机号列表&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    datas &amp;#x3D; datas&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    sms.sendMessage(tid, mobile, datas)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;接下来就可以在view中发送短信了&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#接下来就可以在view中发送短信了&#34;&gt;#&lt;/a&gt; 接下来就可以在 view 中发送短信了&lt;/h2&gt;
&lt;p&gt;send.delay 发送短信&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sms &amp;#x3D; sdk(ACCOUNT_SID, AUTH_TOKEN, APP_ID)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a &amp;#x3D; random.sample([str(i) for i in range(10)], 6)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;code &amp;#x3D; &amp;#39;&amp;#39;.join(a)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r.set(phone, code, 60)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;datas &amp;#x3D; [code, &amp;#39;60s&amp;#39;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;send.delay(sms, mobile&amp;#x3D;[phone], datas&amp;#x3D;datas)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 直接加入消息队列，由celery去管理&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;需要运行两个终端-一个程序-一个异步的终端&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#需要运行两个终端-一个程序-一个异步的终端&#34;&gt;#&lt;/a&gt; 需要运行两个终端 一个程序 一个异步的终端&lt;/h2&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;py manage.py celery worker&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt; ]]></description>
        </item>
    </channel>
</rss>
